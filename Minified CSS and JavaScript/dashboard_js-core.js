// Multi-Site Dashboard JavaScript - CORE MODULE - Dashboard Version: 1.8 - Author: Eric Haupt - Copyright (c) 2025 Eric Haupt - Released under the MIT License. See LICENSE file for details.
window.Dashboard={core:{},data:{},ui:{},logger:{},client:{},instances:{},config:{availableThemes:['theme1','theme2','theme3']}};Dashboard.core.getInstanceState=function(){if(!Dashboard.core.instanceID){Dashboard.core.initializeInstanceIsolation();}if(!Dashboard.instances[Dashboard.core.instanceID]){Dashboard.instances[Dashboard.core.instanceID]={currentSite:'',refreshInterval:10,countdownTimer:null,isLoading:false,currentTheme:'theme1',currentViewMode:'macro',currentAliasMode:true,pendingViewMode:null,initializationComplete:false,wakeLockSentinel:null,wakeLockSupported:false};}return Dashboard.instances[Dashboard.core.instanceID];};Object.defineProperty(Dashboard,'state',{get:function(){return Dashboard.core.getInstanceState();},set:function(value){const instanceState=Dashboard.core.getInstanceState();Object.assign(instanceState,value);}});Dashboard.core.timerState={remainingTime:null,intervalId:null,isPaused:false,lastPauseTime:null,isCountdownOnly:false,currentCountdown:null};Dashboard.core.initializeApplication=function(){try{Dashboard.core.init();Dashboard.data.init();Dashboard.ui.init();Dashboard.core.safeBindGlobalFunctions();Dashboard.core.initializeWakeLock();setTimeout(Dashboard.core.handlePostInitialization,50);}catch(error){setTimeout(function(){try{if(!Dashboard.state.initializationComplete){Dashboard.core.safeBindGlobalFunctions();Dashboard.core.initializeWakeLock();setTimeout(Dashboard.core.handlePostInitialization,100);}}catch(e){}},1000);}};Dashboard.core.generateInstanceID=function(){const timestamp=Date.now().toString(36);const random=Math.random().toString(36).substr(2,5);return`inst_${timestamp}_${random}`;};Dashboard.core.initializeInstanceIsolation=function(){if(!Dashboard.core.instanceID){Dashboard.core.instanceID=Dashboard.core.generateInstanceID();}};Dashboard.core.getStorageKey=function(baseKey){if(!Dashboard.core.instanceID){Dashboard.core.initializeInstanceIsolation();}return`${Dashboard.core.instanceID}_${baseKey}`;};Dashboard.core.init=function(){Dashboard.core.initializeInstanceIsolation();const instanceState=Dashboard.core.getInstanceState();if(!instanceState.currentSite&&window.dashboardConfig){Dashboard.core.loadServerConfig();}if(Dashboard.data&&Dashboard.data.loadAliasMode){Dashboard.data.loadAliasMode();}Dashboard.core.applyTheme(instanceState.currentTheme);Dashboard.core.applyViewMode(instanceState.currentViewMode);Dashboard.core.initializeAliasButton();Dashboard.core.setupEventDelegation();Dashboard.core.setupEventListeners();};Dashboard.core.handlePostInitialization=function(){const modulesReady=Dashboard.client&&Dashboard.client.state&&Dashboard.client.state.initialized&&Dashboard.data&&Dashboard.ui;if(!modulesReady){setTimeout(Dashboard.core.handlePostInitialization,100);return;}if(Dashboard.state.currentSite){if(Dashboard.client&&Dashboard.client.loadPoolData){Dashboard.client.loadPoolData();}Dashboard.core.startAutoRefresh();}else{Dashboard.core.startCountdownOnly();}};Dashboard.core.loadServerConfig=function(){const instanceState=Dashboard.core.getInstanceState();if(window.dashboardConfig){instanceState.currentSite=window.dashboardConfig.currentSite||'';instanceState.refreshInterval=window.dashboardConfig.refreshInterval||10;instanceState.currentTheme=window.dashboardConfig.currentTheme||'theme1';instanceState.currentViewMode=window.dashboardConfig.currentViewMode||'macro';instanceState.currentAliasMode=true;}document.body.classList.add('theme-loaded');if(Dashboard.core.applyViewMode){Dashboard.core.applyViewMode(instanceState.currentViewMode);}};Dashboard.core.initializeWakeLock=function(){const instanceState=Dashboard.core.getInstanceState();instanceState.wakeLockSupported='wakeLock'in navigator;instanceState.wakeLockRestricted=false;instanceState.wakeLockFallbackActive=false;if(instanceState.wakeLockSupported){Dashboard.core.testWakeLockAvailability();}document.addEventListener('visibilitychange',Dashboard.core.handleVisibilityChange);};Dashboard.core.testWakeLockAvailability=async function(){try{const testSentinel=await navigator.wakeLock.request('screen');testSentinel.release();}catch(err){Dashboard.core.handleWakeLockError(err);}};Dashboard.core.performSafetyCheck=function(){setTimeout(function(){if(!Dashboard.state.initializationComplete){Dashboard.core.safeBindGlobalFunctions();}if(Dashboard.state.currentSite&&!Dashboard.state.countdownTimer){Dashboard.core.handlePostInitialization();}},500);};document.addEventListener('DOMContentLoaded',Dashboard.core.initializeApplication);window.addEventListener('load',Dashboard.core.performSafetyCheck);window.addEventListener('beforeunload',Dashboard.core.cleanup);Dashboard.core.loadServerConfig();Dashboard.core.safeBindGlobalFunctions=function(){try{window.toggleTheme=Dashboard.core.toggleTheme;window.toggleViewMode=Dashboard.core.toggleViewMode;window.toggleAlias=Dashboard.core.toggleAlias;if(Dashboard.client&&Dashboard.client.bindGlobalFunctions){Dashboard.client.bindGlobalFunctions();}if(Dashboard.data){if(Dashboard.data.toggleReorderMode){window.toggleReorderMode=Dashboard.data.toggleReorderMode;}if(Dashboard.data.resetAllMemberStates){window.resetAllMemberStates=Dashboard.data.resetAllMemberStates;}if(Dashboard.data.acknowledgeMemberChange){window.acknowledgeMemberChange=Dashboard.data.acknowledgeMemberChange;}}if(Dashboard.logger&&Dashboard.logger.toggleLogger){window.toggleLogger=Dashboard.logger.toggleLogger;}else if(Dashboard.ui&&Dashboard.ui.toggleLogger){window.toggleLogger=Dashboard.ui.toggleLogger;}Dashboard.state.initializationComplete=true;}catch(error){}};Dashboard.core.setupEventDelegation=function(){const poolsGrid=document.getElementById('pools-grid');if(!poolsGrid){return;}poolsGrid.addEventListener('click',function(e){const target=e.target;if(target.classList.contains('status-badge')&&target.classList.contains('clickable')){e.preventDefault();e.stopPropagation();const row=target.closest('tr');const poolContainer=target.closest('.pool-container');if(row&&poolContainer){const actualPoolName=poolContainer.getAttribute('data-pool-name');if(actualPoolName){try{const cacheKey=Dashboard.core.getStorageKey('currentPoolData_'+Dashboard.state.currentSite);const currentData=JSON.parse(sessionStorage.getItem(cacheKey)||'{}');const pool=currentData.pools?currentData.pools.find(p=>p.name===actualPoolName):null;if(pool&&pool.members){const sortedMembers=pool.members.sort(function(a,b){const ipComparison=Dashboard.ui.compareIPAddresses(a.ip,b.ip);if(ipComparison!==0){return ipComparison;}const portA=parseInt(a.port,10);const portB=parseInt(b.port,10);return portA-portB;});const memberRows=row.parentElement.children;const rowIndex=Array.from(memberRows).indexOf(row);if(rowIndex>=0&&rowIndex<sortedMembers.length){const actualMember=sortedMembers[rowIndex];if(Dashboard.data&&Dashboard.data.acknowledgeMemberChange){Dashboard.data.acknowledgeMemberChange(actualPoolName,actualMember.ip,actualMember.port);}}}}catch(e){}}}}return;});document.body.addEventListener('click',function(e){const target=e.target;if(target.classList.contains('mode-toggle')||target.textContent.trim()==='Mode'){e.preventDefault();e.stopPropagation();if(Dashboard.core&&Dashboard.core.toggleViewMode){Dashboard.core.toggleViewMode();}return false;}if(target.classList.contains('alias-toggle')||target.textContent.trim()==='Alias'){e.preventDefault();e.stopPropagation();if(Dashboard.core&&Dashboard.core.toggleAlias){Dashboard.core.toggleAlias();}return false;}if(target.classList.contains('logger-toggle')||target.classList.contains('dashboard-logger-toggle')||target.textContent.trim()==='Logs'){e.preventDefault();e.stopPropagation();const wasLoggerVisible=Dashboard.core.isLoggerCurrentlyVisible();if(Dashboard.logger&&Dashboard.logger.toggleLogger){Dashboard.logger.toggleLogger();}else if(Dashboard.ui&&Dashboard.ui.toggleLogger){Dashboard.ui.toggleLogger();}setTimeout(()=>{const isLoggerVisible=Dashboard.core.isLoggerCurrentlyVisible();if(!wasLoggerVisible&&isLoggerVisible){Dashboard.core.onLoggerVisible();}else if(wasLoggerVisible&&!isLoggerVisible){Dashboard.core.onLoggerHidden();}},50);return false;}if(target.classList.contains('resolve-toggle')||target.textContent.trim()==='Resolve'){e.preventDefault();e.stopPropagation();if(Dashboard.client&&Dashboard.client.resolveDNS){Dashboard.client.resolveDNS();}return false;}if(target.classList.contains('flush-toggle')||target.textContent.trim()==='Flush'){e.preventDefault();e.stopPropagation();if(Dashboard.client&&Dashboard.client.flushDNSCache){Dashboard.client.flushDNSCache();}return false;}if(target.id==='reset-state-button'||target.classList.contains('reset-state-button')){e.preventDefault();e.stopPropagation();if(Dashboard.data&&Dashboard.data.resetAllMemberStates){Dashboard.data.resetAllMemberStates();}return false;}if(target.id==='reorder-toggle'||target.classList.contains('reorder-toggle')){e.preventDefault();e.stopPropagation();if(Dashboard.data&&Dashboard.data.toggleReorderMode){Dashboard.data.toggleReorderMode();}return false;}},true);};Dashboard.core.cleanup=function(){try{Dashboard.core.clearExistingTimer();Dashboard.core.releaseWakeLock();if(Dashboard.client&&Dashboard.client.cleanup){Dashboard.client.cleanup();}if(Dashboard.data&&Dashboard.data.clearPendingLogs){Dashboard.data.clearPendingLogs();}if(Dashboard.data&&Dashboard.data.clearDraggedElement){Dashboard.data.clearDraggedElement();}}catch(error){}};Dashboard.core.requestWakeLock=async function(){const instanceState=Dashboard.core.getInstanceState();if(!instanceState.wakeLockSupported){Dashboard.core.enableFallbackWakeLock();return;}try{instanceState.wakeLockSentinel=await navigator.wakeLock.request('screen');instanceState.wakeLockSentinel.addEventListener('release',()=>{instanceState.wakeLockSentinel=null;});}catch(err){Dashboard.core.handleWakeLockError(err);}};Dashboard.core.releaseWakeLock=function(){const instanceState=Dashboard.core.getInstanceState();try{if(instanceState.wakeLockSentinel){instanceState.wakeLockSentinel.release();instanceState.wakeLockSentinel=null;}}catch(releaseErr){instanceState.wakeLockSentinel=null;}try{Dashboard.core.disableFallbackWakeLock();}catch(fallbackErr){}};Dashboard.core.handleWakeLockError=function(err){const instanceState=Dashboard.core.getInstanceState();let shouldUseFallback=true;if(err.name==='SecurityError'){shouldUseFallback=false;}if(err.name==='SecurityError'||err.name==='NotAllowedError'){instanceState.wakeLockRestricted=true;}if(shouldUseFallback){try{Dashboard.core.enableFallbackWakeLock();}catch(fallbackErr){}}};Dashboard.core.enableFallbackWakeLock=function(){const instanceState=Dashboard.core.getInstanceState();if(instanceState.wakeLockRestricted||instanceState.wakeLockFallbackActive){return;}try{instanceState.wakeLockFallbackInterval=setInterval(()=>{try{document.title=document.title;if(Math.random()<0.1){fetch('/api/health',{method:'HEAD',cache:'no-cache'}).catch(()=>{});}}catch(domErr){}},30000);instanceState.wakeLockFallbackActive=true;}catch(fallbackErr){}};Dashboard.core.disableFallbackWakeLock=function(){const instanceState=Dashboard.core.getInstanceState();try{if(instanceState.wakeLockFallbackInterval){clearInterval(instanceState.wakeLockFallbackInterval);instanceState.wakeLockFallbackInterval=null;}instanceState.wakeLockFallbackActive=false;}catch(cleanupErr){instanceState.wakeLockFallbackActive=false;instanceState.wakeLockFallbackInterval=null;}};Dashboard.core.isLoggerCurrentlyVisible=function(){if(Dashboard.logger&&Dashboard.logger.state&&Dashboard.logger.state.visible){return true;}if(Dashboard.ui&&Dashboard.ui.logger&&Dashboard.ui.logger.visible){return true;}const loggerElement=document.getElementById('dashboard-logger');if(loggerElement){const computedStyle=window.getComputedStyle(loggerElement);return computedStyle.display!=='none';}return false;};Dashboard.core.onLoggerVisible=function(){const instanceState=Dashboard.core.getInstanceState();if(!instanceState.wakeLockRestricted){try{Dashboard.core.requestWakeLock();}catch(err){}}if(document.visibilityState==='hidden'){if(Dashboard.state.currentSite){Dashboard.core.startAutoRefresh();}else{Dashboard.core.startCountdownOnly();}}};Dashboard.core.onLoggerHidden=function(){try{Dashboard.core.releaseWakeLock();}catch(err){}if(document.visibilityState==='hidden'){try{Dashboard.core.pauseTimer();}catch(err){}}};Dashboard.core.handleVisibilityChange=function(){if(document.visibilityState==='visible'){const isLoggerVisible=Dashboard.core.isLoggerCurrentlyVisible();if(isLoggerVisible){Dashboard.core.requestWakeLock();}if(Dashboard.core.timerState.isPaused){Dashboard.core.resumeTimer();}else if(!Dashboard.state.countdownTimer){if(Dashboard.state.currentSite){Dashboard.core.startAutoRefresh();}else{Dashboard.core.startCountdownOnly();}}}else{const isLoggerVisible=Dashboard.core.isLoggerCurrentlyVisible();if(isLoggerVisible){Dashboard.core.requestWakeLock();}else{if(Dashboard.state.countdownTimer&&!Dashboard.core.timerState.isPaused){Dashboard.core.pauseTimer();}Dashboard.core.releaseWakeLock();}}};Dashboard.core.applyTheme=function(theme){if(!Dashboard.config.availableThemes.includes(theme)){theme='theme1';}Dashboard.config.availableThemes.forEach(function(themeName){document.body.classList.remove(themeName);});document.body.classList.add(theme);document.body.setAttribute('data-theme',theme);Dashboard.state.currentTheme=theme;};Dashboard.core.toggleTheme=function(){const currentIndex=Dashboard.config.availableThemes.indexOf(Dashboard.state.currentTheme);const nextIndex=(currentIndex+1)%Dashboard.config.availableThemes.length;const nextTheme=Dashboard.config.availableThemes[nextIndex];Dashboard.core.applyTheme(nextTheme);fetch('/?theme='+encodeURIComponent(nextTheme),{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded','Cache-Control':'no-cache'},body:'theme='+encodeURIComponent(nextTheme)}).then(response=>{if(response.ok){return response.json();}throw new Error('HTTP '+response.status);}).then(data=>{}).catch(error=>{});};Dashboard.core.applyViewMode=function(viewMode){if(viewMode!=='macro'&&viewMode!=='micro'){viewMode='macro';}document.body.classList.remove('macro-view','micro-view');document.body.classList.add(viewMode+'-view');Dashboard.state.currentViewMode=viewMode;};Dashboard.core.applyPendingViewMode=function(){if(Dashboard.state.pendingViewMode){Dashboard.core.applyViewMode(Dashboard.state.pendingViewMode);Dashboard.state.pendingViewMode=null;}};Dashboard.core.toggleViewMode=function(){const currentMode=Dashboard.state.currentViewMode;const nextMode=currentMode==='macro'?'micro':'macro';Dashboard.core.applyViewMode(nextMode);if(Dashboard.state.currentSite){try{const cacheKey=Dashboard.core.getStorageKey('currentPoolData_'+Dashboard.state.currentSite);const currentData=JSON.parse(sessionStorage.getItem(cacheKey)||'{}');if(currentData.pools&&Dashboard.ui&&Dashboard.ui.renderPoolData){Dashboard.ui.renderPoolData(currentData);}}catch(e){}}if(Dashboard.client&&Dashboard.client.sendSettingsRequest){Dashboard.client.sendSettingsRequest('/?viewmode='+encodeURIComponent(nextMode),'viewmode',nextMode).catch(error=>{});}};Dashboard.core.initializeAliasButton=function(){const aliasButton=document.querySelector('.alias-toggle');if(aliasButton){if(Dashboard.state.currentAliasMode){aliasButton.textContent='Alias';aliasButton.classList.remove('alias-active');}else{aliasButton.textContent='Actual';aliasButton.classList.add('alias-active');}}};Dashboard.core.toggleAlias=function(){if(!Dashboard.state.currentSite){return;}const poolsGrid=document.getElementById('pools-grid');const errorMessage=document.getElementById('error-message');const noSiteMessage=document.getElementById('no-site-message');const loadingMessage=document.getElementById('loading-message');const isShowingPoolData=poolsGrid&&window.getComputedStyle(poolsGrid).display!=='none'&&poolsGrid.children.length>0;const isShowingError=errorMessage&&window.getComputedStyle(errorMessage).display!=='none';const isShowingNoSite=noSiteMessage&&window.getComputedStyle(noSiteMessage).display!=='none';const isShowingLoading=loadingMessage&&window.getComputedStyle(loadingMessage).display!=='none';if(!isShowingPoolData||isShowingError||isShowingNoSite||isShowingLoading){return;}const nextMode=!Dashboard.state.currentAliasMode;Dashboard.state.currentAliasMode=nextMode;if(Dashboard.data&&Dashboard.data.saveAliasMode){Dashboard.data.saveAliasMode();}const aliasButton=document.querySelector('.alias-toggle');if(aliasButton){if(nextMode){aliasButton.textContent='Alias';aliasButton.classList.remove('alias-active');}else{aliasButton.textContent='Actual';aliasButton.classList.add('alias-active');}}try{const cacheKey=Dashboard.core.getStorageKey('currentPoolData_'+Dashboard.state.currentSite);const currentData=JSON.parse(sessionStorage.getItem(cacheKey)||'{}');if(currentData.pools&&currentData.hostname&&Dashboard.ui&&Dashboard.ui.renderPoolData){Dashboard.ui.renderPoolData(currentData);}}catch(e){}};Dashboard.core.startAutoRefresh=function(){Dashboard.core.clearExistingTimer();Dashboard.core.timerState.remainingTime=Dashboard.state.refreshInterval;Dashboard.core.timerState.isPaused=false;Dashboard.core.timerState.isCountdownOnly=false;Dashboard.core.updateCountdownDisplay();Dashboard.state.countdownTimer=setInterval(function(){if(Dashboard.core.timerState.isPaused){return;}Dashboard.core.timerState.remainingTime--;Dashboard.core.updateCountdownDisplay();if(Dashboard.core.timerState.remainingTime<=0){if(Dashboard.client&&Dashboard.client.loadPoolData){Dashboard.client.loadPoolData();}Dashboard.core.timerState.remainingTime=Dashboard.state.refreshInterval;}},1000);};Dashboard.core.startCountdownOnly=function(){Dashboard.core.clearExistingTimer();Dashboard.core.timerState.remainingTime=Dashboard.state.refreshInterval;Dashboard.core.timerState.isPaused=false;Dashboard.core.timerState.isCountdownOnly=true;Dashboard.core.updateCountdownDisplay();Dashboard.state.countdownTimer=setInterval(function(){if(Dashboard.core.timerState.isPaused){return;}Dashboard.core.timerState.remainingTime--;Dashboard.core.updateCountdownDisplay();if(Dashboard.core.timerState.remainingTime<=0){if(Dashboard.state.currentSite){Dashboard.core.startAutoRefresh();return;}Dashboard.core.timerState.remainingTime=Dashboard.state.refreshInterval;}},1000);};Dashboard.core.pauseTimer=function(){if(!Dashboard.core.timerState.isPaused&&Dashboard.state.countdownTimer){Dashboard.core.timerState.isPaused=true;Dashboard.core.timerState.lastPauseTime=Date.now();}};Dashboard.core.resumeTimer=function(){if(Dashboard.core.timerState.isPaused){Dashboard.core.timerState.isPaused=false;if(!Dashboard.state.countdownTimer){if(Dashboard.core.timerState.isCountdownOnly){Dashboard.core.startCountdownOnly();}else{Dashboard.core.startAutoRefresh();}}Dashboard.core.updateCountdownDisplay();}};Dashboard.core.clearExistingTimer=function(){if(Dashboard.state.countdownTimer){clearInterval(Dashboard.state.countdownTimer);Dashboard.state.countdownTimer=null;}Dashboard.core.timerState.isPaused=false;};Dashboard.core.updateCountdownDisplay=function(){const countdownElement=document.getElementById('countdown');if(countdownElement){countdownElement.textContent=Dashboard.core.timerState.remainingTime;}};Dashboard.core.saveViewModeForSite=function(siteName,viewMode){if(!siteName)return;const storageKey=Dashboard.core.getStorageKey('viewMode_'+siteName);try{sessionStorage.setItem(storageKey,viewMode);}catch(e){}};Dashboard.core.loadViewModeForSite=function(siteName){if(!siteName)return'micro';const storageKey=Dashboard.core.getStorageKey('viewMode_'+siteName);try{const savedMode=sessionStorage.getItem(storageKey);const validModes=['macro','micro'];if(savedMode&&validModes.includes(savedMode)){return savedMode;}}catch(e){}return'micro';};Dashboard.core.setupEventListeners=function(){};console.log('Dashboard Core module loaded successfully');